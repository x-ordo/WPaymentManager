# Feature Specification: Draft Generation with Fact-Summary

**Feature Branch**: `016-draft-fact-summary`
**Created**: 2025-12-23
**Status**: Draft
**Input**: User description: "초안 생성 시 증거 파일 대신 사실관계 요약(fact-summary) 텍스트를 기반으로 GPT에 전달하도록 변경. 현재 문제: 증거 파일을 RAG로 검색하여 GPT에 전달 시 컨텍스트가 너무 커서 OpenAI API 타임아웃(25초) 발생. 해결책: 이미 생성된 fact-summary 텍스트만 사용하여 초안 생성, 컨텍스트 크기 대폭 감소, 타임아웃 문제 해결"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 사실관계 요약 기반 초안 생성 (Priority: P1)

변호사가 사건 상세 페이지에서 "초안 생성" 버튼을 클릭하면, 시스템은 해당 사건의 사실관계 요약(fact-summary) 텍스트를 기반으로 법률 초안을 생성한다. 기존 증거 파일 RAG 검색 대신 이미 요약된 텍스트만 사용하여 컨텍스트 크기를 줄이고, 타임아웃 없이 안정적으로 초안을 생성한다.

**Why this priority**: 현재 프로덕션에서 초안 생성 시 타임아웃 오류가 발생하여 핵심 기능이 작동하지 않는 치명적인 문제. 즉시 해결이 필요한 최우선 과제.

**Independent Test**: 사실관계 요약이 있는 사건에서 초안 생성을 요청하고, 60초 이내에 초안이 성공적으로 생성되는지 확인.

**Acceptance Scenarios**:

1. **Given** 사실관계 요약이 완료된 사건, **When** 변호사가 초안 생성을 요청, **Then** 시스템은 사실관계 요약 텍스트만 사용하여 초안을 생성하고 60초 이내에 결과를 반환한다
2. **Given** 사실관계 요약이 완료된 사건, **When** 초안 생성이 완료, **Then** 생성된 초안에 사실관계 요약의 핵심 내용이 반영되어 있다
3. **Given** 대용량 증거가 있는 사건, **When** 변호사가 초안 생성을 요청, **Then** 시스템은 증거 파일 RAG 검색 없이 사실관계 요약만 사용하여 타임아웃 없이 초안을 생성한다

---

### User Story 2 - 사실관계 요약 미존재 시 처리 (Priority: P2)

사실관계 요약이 아직 생성되지 않은 사건에서 초안 생성을 요청할 경우, 시스템은 사용자에게 먼저 사실관계 요약을 생성하도록 안내한다.

**Why this priority**: 사실관계 요약이 없는 경우에 대한 예외 처리가 필요하지만, 대부분의 사건은 이미 사실관계 요약이 있을 것으로 예상됨.

**Independent Test**: 사실관계 요약이 없는 사건에서 초안 생성 시 적절한 안내 메시지가 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 사실관계 요약이 없는 사건, **When** 변호사가 초안 생성을 요청, **Then** "사실관계 요약을 먼저 생성해주세요" 안내 메시지가 표시된다
2. **Given** 사실관계 요약이 없는 사건, **When** 안내 메시지 표시 후, **Then** 사실관계 요약 생성 버튼/링크로 이동할 수 있다

---

### User Story 3 - 초안 품질 유지 (Priority: P3)

사실관계 요약 기반으로 생성된 초안이 기존 RAG 기반 초안과 동등하거나 더 나은 품질을 유지해야 한다.

**Why this priority**: 기능 정상화가 우선이지만, 초안 품질도 법률 서비스의 핵심이므로 중요.

**Independent Test**: 동일 사건에 대해 생성된 초안이 법률 문서 형식을 갖추고 사건 핵심 내용을 포함하는지 확인.

**Acceptance Scenarios**:

1. **Given** 사실관계 요약이 포함된 사건, **When** 초안이 생성됨, **Then** 초안은 법률 문서 형식(청구취지, 청구원인, 증거 등)을 갖춘다
2. **Given** 생성된 초안, **When** 변호사가 검토, **Then** 사건의 핵심 사실관계가 초안에 적절히 반영되어 있다

---

### Edge Cases

- 사실관계 요약이 빈 문자열인 경우 어떻게 처리할 것인가? → 사실관계 요약 미존재와 동일하게 처리
- 사실관계 요약이 매우 긴 경우(토큰 한도 초과) 어떻게 처리할 것인가? → 요약 텍스트가 일반적으로 증거 원본보다 훨씬 작으므로 발생 가능성 낮음, 발생 시 텍스트 자르기 적용
- 초안 생성 중 네트워크 오류가 발생한 경우? → 기존 오류 처리 로직 유지, 재시도 안내
- 동시에 여러 초안 생성 요청이 들어온 경우? → 기존 비동기 처리 로직 유지

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 초안 생성 시 증거 파일 RAG 검색 대신 사실관계 요약(fact-summary) 텍스트를 사용해야 한다
- **FR-002**: 시스템은 사건의 사실관계 요약 존재 여부를 확인한 후 초안 생성을 진행해야 한다
- **FR-003**: 사실관계 요약이 없는 경우 사용자에게 명확한 안내 메시지를 제공해야 한다
- **FR-004**: 생성된 초안은 법률 문서 형식(청구취지, 청구원인, 증거 목록 등)을 갖춰야 한다
- **FR-005**: 시스템은 기존 비동기 초안 생성 아키텍처를 유지해야 한다
- **FR-006**: 초안 생성 요청부터 완료까지 60초 이내에 처리되어야 한다

### Key Entities

- **Case (사건)**: 사건 ID, 사건 유형, 당사자 정보를 포함하는 핵심 엔티티
- **Fact-Summary (사실관계 요약)**: 사건별로 생성된 사실관계 요약 텍스트, 사건과 1:1 관계
- **Draft (초안)**: 생성된 법률 문서 초안, 사건과 1:N 관계

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 초안 생성 성공률이 95% 이상 (현재 타임아웃으로 인해 낮은 성공률 → 개선)
- **SC-002**: 초안 생성 소요 시간이 60초 이내 (현재 타임아웃 발생 → 안정적 완료)
- **SC-003**: 사용자가 생성된 초안을 수정 없이 사용 가능한 비율 70% 이상 유지
- **SC-004**: 타임아웃 관련 오류 발생률 0% (현재 빈번한 발생 → 완전 해결)

## Assumptions

- 사실관계 요약(fact-summary) 기능은 이미 구현되어 있으며, 대부분의 사건에 사실관계 요약이 존재한다
- 사실관계 요약 텍스트는 증거 원본 대비 컨텍스트 크기가 현저히 작다 (예상 감소율: 90% 이상)
- 기존 초안 생성 프롬프트 및 출력 형식은 유지하되, 입력 소스만 변경한다
- OpenAI API 호출 타임아웃 설정(60초)은 유지한다

## Out of Scope

- 사실관계 요약 자체의 품질 개선
- 새로운 초안 유형 추가
- 프론트엔드 UI/UX 변경 (오류 메시지 외)
- 타 LLM 서비스로의 전환 (Gemini 등)
