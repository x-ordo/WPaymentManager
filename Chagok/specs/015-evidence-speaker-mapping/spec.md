# Feature Specification: 증거 화자 매핑

**Feature Branch**: `015-evidence-speaker-mapping`
**Created**: 2025-12-22
**Status**: Draft
**Input**: 증거 화자 매핑 - 대화형 증거에서 화자가 누구인지 선택적으로 지정하여 사실관계 생성 정확도 향상. 인물관계도의 인물과 연결하여 나/상대방 등의 화자를 실제 인물로 매핑

## Overview

카카오톡 캡쳐, 문자 메시지 등 대화형 증거에서 "나", "상대방" 등으로 표시되는 화자가 실제 누구인지 파악하기 어려운 문제를 해결합니다. 변호사가 증거의 대화 참여자를 인물관계도의 인물과 연결하면, 사실관계 생성 시 AI가 정확한 맥락으로 해석할 수 있습니다.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 증거 화자 매핑 설정 (Priority: P1)

변호사가 대화형 증거(카톡 캡쳐 등)를 확인한 후, 해당 대화의 참여자가 누구인지 인물관계도에서 선택하여 지정합니다. 이 설정은 선택사항이며, 설정하지 않아도 기존처럼 동작합니다.

**Why this priority**: 핵심 기능이며, 이 기능 없이는 사실관계 정확도 향상이 불가능합니다.

**Independent Test**: 증거 상세 화면에서 대화 참여자를 선택하고 저장 → 다음 접속 시 설정값 유지 확인

**Acceptance Scenarios**:

1. **Given** 대화형 증거가 업로드되어 있고 인물관계도에 인물이 등록되어 있을 때, **When** 변호사가 증거 상세 화면에서 "대화 참여자 매핑"을 클릭하고 인물을 선택하여 저장하면, **Then** 해당 매핑 정보가 저장되고 화면에 표시됩니다.

2. **Given** 화자 매핑이 이미 설정된 증거가 있을 때, **When** 변호사가 매핑을 수정하거나 삭제하면, **Then** 변경사항이 즉시 반영됩니다.

3. **Given** 어떤 증거에서든, **When** 변호사가 화자 매핑을 설정하지 않으면, **Then** 기존처럼 "나/상대방" 등 원본 화자명으로 처리됩니다.

---

### User Story 2 - 화자 매핑 기반 사실관계 생성 (Priority: P1)

화자 매핑이 설정된 증거가 있을 때, 사실관계 생성 시 AI가 해당 맥락을 이해하여 "나 = 김동우", "상대방 = 김도연" 등으로 정확하게 해석합니다.

**Why this priority**: 화자 매핑의 실질적 가치를 제공하는 핵심 기능입니다.

**Independent Test**: 화자 매핑 설정 후 사실관계 생성 → 생성된 사실관계에서 실제 인물명으로 대화 내용이 정리되었는지 확인

**Acceptance Scenarios**:

1. **Given** 증거에 화자 매핑이 설정되어 있을 때 (나=김동우, 상대방=김도연), **When** 사실관계를 생성하면, **Then** AI가 대화 내용을 "김동우가 김도연에게..." 형태로 정확하게 해석합니다.

2. **Given** 일부 증거에만 화자 매핑이 설정되어 있을 때, **When** 사실관계를 생성하면, **Then** 매핑된 증거는 실제 인물명으로, 매핑되지 않은 증거는 기존처럼 처리됩니다.

---

### User Story 3 - 증거 목록에서 매핑 상태 확인 (Priority: P2)

변호사가 증거 목록에서 어떤 증거에 화자 매핑이 설정되어 있는지 한눈에 파악할 수 있습니다.

**Why this priority**: 편의 기능으로, 핵심 기능 완료 후 추가합니다.

**Independent Test**: 증거 목록 화면에서 매핑 설정된 증거에 뱃지/아이콘 표시 확인

**Acceptance Scenarios**:

1. **Given** 화자 매핑이 설정된 증거가 있을 때, **When** 증거 목록을 조회하면, **Then** 해당 증거에 매핑 표시(아이콘 또는 뱃지)가 나타납니다.

2. **Given** 화자 매핑이 설정된 증거의 표시를 클릭하면, **When** 클릭 시, **Then** 매핑된 인물 정보를 툴팁이나 팝오버로 확인할 수 있습니다.

---

### Edge Cases

- 인물관계도에 인물이 없을 때: 화자 매핑 UI는 표시되지만 "인물관계도에서 인물을 먼저 등록해주세요" 안내 표시
- 매핑된 인물이 인물관계도에서 삭제될 때: 해당 매핑은 자동으로 해제되고 원본 화자명으로 복원
- 대화형이 아닌 증거(사진, 문서 등): 화자 매핑 UI는 모든 증거 유형에서 표시 (선택사항이므로)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 증거별로 화자 매핑 정보를 저장할 수 있어야 합니다 (선택사항)
- **FR-002**: 화자 매핑은 인물관계도에 등록된 인물 목록에서 선택하는 방식이어야 합니다
- **FR-003**: 하나의 증거에 여러 화자를 매핑할 수 있어야 합니다 (예: 화자1=김동우, 화자2=김도연)
- **FR-004**: 화자 매핑 정보는 수정 및 삭제가 가능해야 합니다
- **FR-005**: 사실관계 생성 시 화자 매핑 정보가 AI 프롬프트에 포함되어야 합니다
- **FR-006**: 화자 매핑이 없는 증거는 기존 방식대로 처리되어야 합니다
- **FR-007**: 증거 목록에서 화자 매핑 설정 여부를 시각적으로 구분할 수 있어야 합니다

### Key Entities

- **SpeakerMapping**: 증거와 인물 간의 화자 매핑 관계
  - 증거 ID와 연결
  - 원본 화자명 (예: "나", "상대방", "화자1")
  - 매핑된 인물 ID (인물관계도 참조)
  - 매핑된 인물명 (조회 편의를 위한 캐시)

- **Evidence (기존 확장)**: 증거 엔티티에 화자 매핑 정보 추가
  - speaker_mapping: 화자명 → 인물ID 매핑 객체 (optional)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 화자 매핑 설정 완료까지 30초 이내 (2명 매핑 기준)
- **SC-002**: 화자 매핑이 설정된 증거의 사실관계 생성 시, 실제 인물명이 정확히 반영되어야 함
- **SC-003**: 화자 매핑 미설정 시에도 기존 기능이 정상 동작해야 함 (하위 호환성)
- **SC-004**: 증거 목록에서 매핑 상태를 3초 이내에 파악할 수 있어야 함

## Assumptions

- 인물관계도(Party Node) 기능이 이미 구현되어 있고, 인물 목록 조회 API가 존재함
- 증거 데이터는 DynamoDB에 저장되며, 스키마 확장이 가능함
- 사실관계 생성 기능(014-case-fact-summary)이 이미 구현되어 있음

## Dependencies

- **012-precedent-integration**: 인물관계도(PartyNode) 기능 활용
- **014-case-fact-summary**: 사실관계 생성 프롬프트 수정

## Out of Scope

- AI가 자동으로 화자를 추론하여 매핑하는 기능 (수동 매핑만 지원)
- 화자 매핑 히스토리/버전 관리
- 여러 증거의 화자를 한 번에 일괄 매핑하는 기능
