# Feature Specification: 사건 전체 사실관계 요약

**Feature Branch**: `014-case-fact-summary`
**Created**: 2025-12-22
**Status**: Draft
**Input**: 사건 전체 사실관계 요약 기능: 개별 증거들의 AI 요약을 종합하여 사건 전체 사실관계(스토리)를 생성하고, 변호사가 이를 수정한 후, 수정된 내용을 기반으로 초안 생성 및 판례 추천에 활용

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI 기반 사건 사실관계 자동 생성 (Priority: P1)

변호사가 사건에 증거를 업로드한 후, 개별 증거들의 AI 요약을 종합하여 전체 사건의 사실관계(스토리)를 자동으로 생성받는다. 이를 통해 변호사는 사건의 전체 맥락을 빠르게 파악할 수 있다.

**Why this priority**: 핵심 기능으로, 변호사가 개별 증거를 일일이 읽지 않고도 사건 전체 그림을 파악할 수 있게 해주는 가장 중요한 가치를 제공한다.

**Independent Test**: 3개 이상의 증거가 업로드된 사건에서 "사실관계 생성" 버튼을 클릭하면, 시간순으로 정리된 사건 스토리가 생성되어 표시된다.

**Acceptance Scenarios**:

1. **Given** 사건에 3개 이상의 증거가 업로드되고 AI 분석이 완료된 상태, **When** 변호사가 "사실관계 생성" 버튼을 클릭, **Then** 시스템은 개별 증거 요약을 종합하여 시간순 사실관계 스토리를 생성하고 표시한다
2. **Given** 사건에 증거가 업로드되지 않은 상태, **When** 변호사가 "사실관계 생성"을 시도, **Then** 시스템은 "분석된 증거가 없습니다" 메시지를 표시한다
3. **Given** 사실관계 생성 중인 상태, **When** 생성이 진행 중, **Then** 시스템은 로딩 상태를 표시하고 생성 완료 시 자동으로 결과를 표시한다

---

### User Story 2 - 사실관계 수정 및 저장 (Priority: P1)

변호사가 AI가 생성한 사실관계를 검토하고, 실제 사건에 맞게 내용을 수정하거나 보완한 후 저장한다. 수정된 내용은 이후 초안 생성과 판례 추천의 기반이 된다.

**Why this priority**: AI 생성 결과를 변호사가 검증하고 수정하는 것이 법률 서비스의 핵심 품질 보장 단계이다.

**Independent Test**: 생성된 사실관계 텍스트를 직접 편집하고 저장 버튼을 클릭하면, 수정된 내용이 저장되고 다음 접속 시에도 유지된다.

**Acceptance Scenarios**:

1. **Given** AI가 생성한 사실관계가 표시된 상태, **When** 변호사가 텍스트를 수정하고 저장 버튼을 클릭, **Then** 수정된 내용이 저장되고 "저장 완료" 알림이 표시된다
2. **Given** 변호사가 사실관계를 수정 중인 상태, **When** 페이지를 벗어나려 할 때, **Then** 시스템은 "저장하지 않은 변경사항이 있습니다" 경고를 표시한다
3. **Given** 수정된 사실관계가 저장된 상태, **When** 변호사가 다시 사건 페이지를 방문, **Then** 이전에 저장한 수정된 사실관계가 표시된다

---

### User Story 3 - 사실관계 기반 초안 생성 (Priority: P2)

변호사가 수정/확정한 사실관계를 기반으로 법률 문서 초안을 생성한다. 초안은 변호사가 정리한 사실관계를 정확히 반영해야 한다.

**Why this priority**: 사실관계 수정이 실질적인 가치를 갖기 위해 초안 생성과 연계되어야 한다.

**Independent Test**: 사실관계를 수정/저장한 후 초안 생성을 실행하면, 생성된 초안이 수정된 사실관계 내용을 인용하고 반영한다.

**Acceptance Scenarios**:

1. **Given** 변호사가 사실관계를 수정하고 저장한 상태, **When** 초안 생성을 요청, **Then** 생성된 초안은 수정된 사실관계 내용을 기반으로 작성된다
2. **Given** 사실관계가 저장되지 않은 상태, **When** 초안 생성을 요청, **Then** 시스템은 기존 AI 생성 사실관계 또는 개별 증거 기반으로 초안을 생성한다

---

### User Story 4 - 사실관계 기반 판례 추천 (Priority: P2)

변호사가 수정한 사실관계를 기반으로 유사한 판례를 검색하고 추천받는다. 단순 키워드가 아닌 사건의 전체 맥락을 반영한 검색이 이루어진다.

**Why this priority**: 현재 유책사유 키워드 기반 검색의 한계를 극복하여 더 정확한 판례를 추천할 수 있다.

**Independent Test**: 수정된 사실관계가 저장된 상태에서 판례 검색을 실행하면, 사실관계 내용과 유사한 맥락의 판례가 우선적으로 표시된다.

**Acceptance Scenarios**:

1. **Given** 변호사가 사실관계를 수정하고 저장한 상태, **When** 판례 검색을 요청, **Then** 시스템은 수정된 사실관계 전체 내용을 검색 쿼리로 활용하여 유사 판례를 반환한다
2. **Given** 사실관계가 없거나 저장되지 않은 상태, **When** 판례 검색을 요청, **Then** 시스템은 기존 방식(유책사유 키워드)으로 판례를 검색한다

---

### User Story 5 - 사실관계 재생성 (Priority: P3)

변호사가 새로운 증거를 추가하거나 기존 사실관계를 초기화하고 싶을 때, AI 사실관계를 다시 생성할 수 있다.

**Why this priority**: 사건 진행 중 증거가 추가되는 경우를 지원하는 부가 기능이다.

**Independent Test**: "재생성" 버튼을 클릭하면 최신 증거를 반영한 새로운 사실관계가 생성된다.

**Acceptance Scenarios**:

1. **Given** 이미 사실관계가 생성/수정된 상태에서 새 증거가 추가됨, **When** 변호사가 "재생성" 버튼을 클릭, **Then** 시스템은 모든 증거(기존+새 증거)를 포함하여 사실관계를 다시 생성한다
2. **Given** 수정된 사실관계가 있는 상태, **When** "재생성"을 클릭, **Then** 시스템은 "기존 수정 내용이 삭제됩니다" 확인을 요청하고, 확인 시 재생성을 진행한다

---

### Edge Cases

- 증거가 1개만 있을 때: 해당 증거의 요약을 사실관계의 기초로 사용하고, "추가 증거를 업로드하면 더 정확한 사실관계를 생성할 수 있습니다" 안내 표시
- 증거 분석이 진행 중일 때: "일부 증거가 분석 중입니다. 완료 후 재생성하면 더 정확한 결과를 얻을 수 있습니다" 안내 표시
- 사실관계가 매우 길 경우 (증거 50개 이상): 핵심 사건 위주로 요약하고, 상세 내용은 펼쳐보기로 제공
- 네트워크 오류로 생성 실패 시: 오류 메시지와 함께 "다시 시도" 버튼 표시
- 세션 만료 시 저장 시도: 재로그인 안내 후 임시 저장된 내용 복구 시도

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 사건의 모든 증거 AI 요약을 수집하여 통합된 사실관계 스토리를 생성해야 한다
- **FR-002**: 생성된 사실관계는 시간순으로 정렬되어야 한다
- **FR-003**: 사실관계에는 각 내용의 출처 증거가 표시되어야 한다 (예: "[증거1] 2023년 3월...")
- **FR-004**: 변호사는 사실관계 텍스트를 자유롭게 편집할 수 있어야 한다
- **FR-005**: 수정된 사실관계는 사건별로 저장되어야 한다
- **FR-006**: 수정 이력은 최소 최근 버전 1개를 보관해야 한다 (이전 버전으로 되돌리기 가능)
- **FR-007**: 초안 생성 시 저장된 사실관계(수정본 우선, 없으면 AI 생성본)를 우선 참조해야 한다
- **FR-008**: 판례 검색 시 저장된 사실관계를 검색 컨텍스트로 활용해야 한다
- **FR-009**: 사실관계 생성/저장/조회는 해당 사건 접근 권한이 있는 사용자만 가능해야 한다
- **FR-010**: 사실관계 생성 중 진행 상태를 사용자에게 표시해야 한다

### Key Entities

- **CaseFactSummary**: 사건별 사실관계 요약 데이터
  - 사건 ID와 연결
  - AI 생성 원본 사실관계
  - 변호사 수정 사실관계
  - 생성/수정 시간
  - 수정자 정보

- **FactSummaryVersion**: 사실관계 버전 이력
  - 이전 버전 내용
  - 버전 생성 시간
  - 버전 생성자

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 변호사가 10개 이상의 증거를 개별 검토하는 데 걸리는 시간 대비, 사실관계 요약을 통해 사건 파악에 걸리는 시간이 50% 이상 단축된다
- **SC-002**: 생성된 사실관계에서 증거 출처가 명확히 표시된 항목이 90% 이상이다
- **SC-003**: 사실관계 수정 후 저장된 내용이 초안 생성에 정확히 반영되는 비율이 100%이다
- **SC-004**: 사실관계 기반 판례 검색이 기존 키워드 기반 검색 대비 사용자 만족도가 높다 (설문 기준 4점/5점 이상)
- **SC-005**: 사실관계 생성은 증거 20개 기준 30초 이내에 완료된다

## Assumptions

- 개별 증거의 AI 요약(ai_summary)은 AI Worker에 의해 이미 생성되어 DynamoDB에 저장되어 있다
- 증거에는 timestamp 또는 정렬 가능한 시간 정보가 포함되어 있다
- 사용자 인증 및 사건 접근 권한 검증 시스템이 이미 구현되어 있다
- 기존 초안 생성(DraftService) 및 판례 검색(PrecedentService)이 구현되어 있다
