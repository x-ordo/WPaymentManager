# USERFLOW.md — CHAGOK 사용자 흐름 상세 설계서

**문서 버전**: v1.1
**작성일**: 2025-11-28
**최종 수정**: 2025-12-03
**작성자**: Team H·P·L

---

## 변경 이력 (Change Log)

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v1.0 | 2025-11-28 | Team H·P·L | 최초 작성 |
| v1.1 | 2025-12-03 | L-work | Draft 생성 시스템 업데이트 (JSON 템플릿, DocumentRenderer 추가) |

---

## 0. 문서 목적

이 문서는 CHAGOK (CHAGOK)의 **모든 사용자 흐름(User Flow)**을 정의한다.

- 각 사용자 유형별 주요 흐름
- 페이지별 상세 인터랙션
- 현재 구현 상태 및 향후 계획

> **팀원 참고**: 이 문서는 프론트엔드/백엔드/AI 파이프라인 전체 흐름을 다룹니다.
> 담당 영역별 상세 구현은 각 SPEC 문서를 참고하세요.

---

## 1. 현황 요약 (Implementation Status)

### 1.1 프론트엔드 페이지 현황

| 페이지 | 라우트 | 상태 | 설명 |
|--------|--------|------|------|
| 랜딩 페이지 | `/` | ✅ 완료 | 12개 섹션 (Hero, Pricing, FAQ 등) |
| 로그인 | `/login` | ✅ 완료 | JWT 기반 인증 |
| 회원가입 | `/signup` | ✅ 완료 | 이용약관 동의 포함 |
| 케이스 목록 | `/cases` | ✅ 완료 | 대시보드 |
| 케이스 상세 | `/cases/[id]` | ✅ 완료 | 타임라인, 증거, Draft |
| 탐정 페이지 | `/detective` | 🔲 계획 | 탐정 서비스 연동 |
| 의뢰인 포털 | `/client/[token]` | 🔲 계획 | 의뢰인 증거 업로드 |
| 법률문서 | `/documents` | 🔲 계획 | 템플릿 관리 |
| 관리자 | `/admin/*` | ✅ 완료 | 사용자/역할/감사로그 |
| 설정 | `/settings/*` | ✅ 완료 | 빌링, 구독 관리 |

### 1.2 백엔드 API 현황

| 영역 | 상태 | 주요 엔드포인트 |
|------|------|-----------------|
| 인증 | ✅ 완료 | `/auth/login`, `/auth/signup` |
| 케이스 관리 | ✅ 완료 | `/cases/*` |
| 증거 관리 | ✅ 완료 | `/evidence/*`, `/cases/{id}/evidence` |
| Draft 생성 | ✅ 완료 | `/cases/{id}/draft-preview` |
| 관리자 | ✅ 완료 | `/admin/*` |
| 탐정 연동 | 🔲 계획 | `/detective/*` |
| 의뢰인 포털 | 🔲 계획 | `/client/*` |

### 1.3 AI Worker 현황

| 기능 | 상태 | 설명 |
|------|------|------|
| S3 Event 파싱 | ✅ 완료 | URL 디코딩 포함 |
| 텍스트 파싱 | ✅ 완료 | 카카오톡 자동 감지 (txt, csv) |
| 이미지 OCR/Vision | ✅ 완료 | GPT-4o Vision |
| 오디오 STT | ✅ 완료 | OpenAI Whisper |
| Article 840 태깅 | ✅ 완료 | 7개 유책사유 분류 |
| 벡터 임베딩 | ✅ 완료 | Qdrant 저장 (case_rag_{case_id}) |
| **TemplateStore** | ✅ 완료 | 법률 문서 템플릿 저장소 (12/3 추가) |

### 1.4 Draft 생성 시스템 현황 (12/3 업데이트)

| 기능 | 상태 | 설명 |
|------|------|------|
| RAG 검색 | ✅ 완료 | 증거 + 법률지식 벡터 검색 |
| GPT-4o 생성 | ✅ 완료 | 소장 초안 자동 생성 |
| JSON 템플릿 | ✅ 완료 | 문서 형식 메타데이터 포함 스키마 |
| DocumentRenderer | ✅ 완료 | JSON → 포맷팅된 텍스트 변환 |
| DOCX 내보내기 | ✅ 완료 | Word 문서 다운로드 |
| PDF 내보내기 | ✅ 완료 | 한글 폰트 지원 |

---

## 2. 사용자 유형 정의

### 2.1 변호사 (Lawyer)
- **역할**: 케이스 생성, 증거 분석, Draft 생성/편집
- **권한**: 자신이 담당하는 케이스 전체 접근
- **주요 화면**: 케이스 목록, 케이스 상세, Draft 에디터

### 2.2 스태프 (Staff)
- **역할**: 증거 업로드, 기초 정리 작업
- **권한**: 배정된 케이스에 대한 읽기/쓰기
- **주요 화면**: 케이스 목록, 증거 업로드

### 2.3 관리자 (Admin)
- **역할**: 사용자 관리, 권한 설정, 감사 로그 조회
- **권한**: 시스템 전체 관리
- **주요 화면**: 관리자 대시보드, 사용자 목록, 감사 로그

### 2.4 의뢰인 (Client)
- **역할**: 증거 제출 (읽기 전용 포털)
- **권한**: 초대받은 케이스에 증거 업로드만 가능
- **주요 화면**: 의뢰인 증거 제출 포털

### 2.5 탐정 (Detective) - 신규
- **역할**: 증거 수집 의뢰 접수, 진행 상황 리포트
- **권한**: 배정된 조사 건에 대한 읽기/쓰기
- **주요 화면**: 탐정 대시보드, 조사 요청 목록

---

## 3. 메인 사용자 흐름 (Main User Flows)

### 3.1 신규 사용자 온보딩 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                        랜딩 페이지 (/)                          │
│  Hero → Social Proof → Problem → Solution → Pricing → FAQ       │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │  무료 체험    │    │   로그인     │
            │  버튼 클릭    │    │   버튼 클릭  │
            └──────────────┘    └──────────────┘
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │  회원가입     │    │  로그인      │
            │  (/signup)   │    │  (/login)    │
            └──────────────┘    └──────────────┘
                    │                   │
                    └─────────┬─────────┘
                              ▼
                    ┌──────────────────┐
                    │  케이스 대시보드  │
                    │    (/cases)      │
                    └──────────────────┘
```

### 3.2 케이스 관리 플로우 (변호사)

```
┌──────────────────────────────────────────────────────────────────┐
│                     케이스 대시보드 (/cases)                      │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐      │
│  │ 케이스 카드1 │ 케이스 카드2 │ 케이스 카드3 │ + 새 사건   │      │
│  └─────────────┴─────────────┴─────────────┴─────────────┘      │
└──────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
    ┌──────────┐       ┌──────────┐       ┌───────────┐
    │ 카드 클릭 │       │ 새 사건  │       │ 검색/필터 │
    └──────────┘       │ 버튼 클릭 │       └───────────┘
          │            └──────────┘              │
          │                   │                  │
          ▼                   ▼                  ▼
    ┌──────────────┐  ┌──────────────┐   ┌──────────────┐
    │ 케이스 상세   │  │ 사건 생성    │   │ 필터링된     │
    │ (/cases/[id])│  │ 모달         │   │ 케이스 목록  │
    └──────────────┘  └──────────────┘   └──────────────┘
```

### 3.3 증거 처리 플로우

```
┌──────────────────────────────────────────────────────────────────┐
│                  케이스 상세 (/cases/[id])                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ CaseHeader: 사건명 | 상태 | 멤버 | [증거업로드] [사건종료]   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌──────────────┬──────────────────────────────────────────────┐ │
│  │ 필터바       │ 증거 타임라인                                │ │
│  │ - 유형       │ ┌────────────────────────────────────┐       │ │
│  │ - 날짜       │ │ [2024-01-15] 카카오톡 대화 - 원고  │       │ │
│  │ - 유책사유   │ │ [2024-01-16] 녹음 파일 - 피고      │       │ │
│  │              │ │ [2024-01-17] 이미지 - 증거사진     │       │ │
│  │              │ └────────────────────────────────────┘       │ │
│  └──────────────┴──────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Draft Preview: AI 초안 영역                                 │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
    ┌─────────────────────────┼─────────────────────────┐
    ▼                         ▼                         ▼
┌─────────────┐       ┌─────────────┐           ┌─────────────┐
│ 증거 업로드 │       │ 증거 상세   │           │ Draft 생성  │
│ (드래그앤   │       │ 모달        │           │ 버튼 클릭   │
│ 드롭)       │       │             │           │             │
└─────────────┘       └─────────────┘           └─────────────┘
      │                     │                         │
      ▼                     ▼                         ▼
┌─────────────┐       ┌─────────────┐           ┌─────────────┐
│ S3 업로드   │       │ - 원본 보기 │           │ RAG 검색    │
│ (Presigned) │       │ - AI 요약   │           │ GPT-4o 생성 │
│     ↓       │       │ - 라벨 태그 │           │ 초안 표시   │
│ AI Worker   │       │ - 하이라이트│           │     ↓       │
│ 자동 분석   │       └─────────────┘           │ DOCX 다운로드│
└─────────────┘                                 └─────────────┘
```

### 3.4 Draft 생성 상세 플로우 (v1.1 신규)

> **12/3 업데이트**: JSON 템플릿 시스템 도입으로 Draft 생성 품질 향상

```
┌──────────────────────────────────────────────────────────────────┐
│                    Draft 생성 버튼 클릭                           │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 1. RAG 검색 (draft_service.py)                                   │
│    ├─ 증거 검색: Qdrant case_rag_{case_id} 컬렉션                │
│    └─ 법률지식 검색: Qdrant leh_legal_knowledge 컬렉션           │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 2. 템플릿 조회 (Qdrant legal_templates)                          │
│    ├─ 템플릿 있음 → JSON 스키마 기반 출력 모드                    │
│    └─ 템플릿 없음 → 기존 텍스트 출력 모드 (fallback)             │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 3. GPT-4o 프롬프트 생성                                          │
│    ├─ 시스템 프롬프트: 법률 전문가 역할 + JSON 스키마             │
│    ├─ 증거 컨텍스트: RAG 검색 결과                               │
│    └─ 법률 컨텍스트: 민법 제840조 등                             │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 4. GPT-4o 응답 처리                                              │
│    ├─ JSON 모드: DocumentRenderer.parse_json_response()          │
│    │             → DocumentRenderer.render_to_text()             │
│    └─ 텍스트 모드: 원본 응답 그대로 사용                         │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 5. 결과 반환                                                     │
│    ├─ draft_text: 포맷팅된 소장 초안                             │
│    ├─ citations: 인용된 증거 목록                                │
│    └─ generated_at: 생성 시간                                    │
└──────────────────────────────────────────────────────────────────┘
```

#### 관련 파일 (담당자 참고)

| 파일 | 위치 | 담당 | 설명 |
|------|------|------|------|
| `draft_service.py` | backend/app/services/ | Backend | Draft 생성 로직 |
| `document_renderer.py` | backend/app/services/ | Backend | JSON→텍스트 변환 |
| `template_store.py` | ai_worker/src/storage/ | AI Worker | 템플릿 저장소 |
| `qdrant.py` | backend/app/utils/ | Backend | 템플릿 조회 함수 |
| `divorce_complaint_schema.json` | docs/ | 공통 | 이혼소장 JSON 스키마 |

---

## 4. 탐정 페이지 (Detective Page) - 신규

### 4.1 개요

탐정 페이지는 **변호사가 탐정 서비스에 증거 수집을 의뢰**하고, **탐정이 조사 결과를 업로드**하는 연동 시스템이다.

### 4.2 사용자 유형별 흐름

#### 4.2.1 변호사 → 탐정 의뢰 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│                    탐정 서비스 페이지 (/detective)                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 상단 배너: "전문 탐정과 함께 증거 수집을 의뢰하세요"         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────┬─────────────┬─────────────┐                    │
│  │  진행 중    │  완료       │  + 새 의뢰  │                    │
│  │  조사 (3)   │  조사 (12)  │             │                    │
│  └─────────────┴─────────────┴─────────────┘                    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 조사 목록 테이블                                            │ │
│  │ ┌────────┬────────┬──────────┬──────────┬─────────┐        │ │
│  │ │ 의뢰번호│ 케이스명│ 조사유형  │ 상태     │ 담당탐정 │        │ │
│  │ ├────────┼────────┼──────────┼──────────┼─────────┤        │ │
│  │ │ D-001  │ 김XX사건│ 미행조사  │ 진행중   │ 박탐정  │        │ │
│  │ │ D-002  │ 이XX사건│ 녹음수집  │ 완료     │ 최탐정  │        │ │
│  │ │ D-003  │ 박XX사건│ 사진촬영  │ 대기중   │ 미배정  │        │ │
│  │ └────────┴────────┴──────────┴──────────┴─────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │ 새 의뢰 생성 │    │ 상세 보기    │
            └──────────────┘    └──────────────┘
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │ 의뢰서 작성  │    │ 조사 진행상황│
            │ - 케이스 선택│    │ - 타임라인   │
            │ - 조사유형   │    │ - 리포트     │
            │ - 요청사항   │    │ - 증거파일   │
            │ - 예산범위   │    │ - 비용내역   │
            └──────────────┘    └──────────────┘
```

#### 4.2.2 탐정 → 조사 결과 업로드 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│                탐정 대시보드 (/detective/dashboard)               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 환영합니다, 박탐정님! 현재 진행 중 조사: 3건                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 배정된 조사 목록                                            │ │
│  │ ┌────────┬──────────┬──────────┬──────────┬────────┐       │ │
│  │ │ 의뢰번호│ 조사유형  │ 마감일    │ 상태     │ 액션   │       │ │
│  │ ├────────┼──────────┼──────────┼──────────┼────────┤       │ │
│  │ │ D-001  │ 미행조사  │ 2024-02-01│ 진행중   │ [상세] │       │ │
│  │ │ D-004  │ 녹음수집  │ 2024-02-05│ 신규     │ [수락] │       │ │
│  │ └────────┴──────────┴──────────┴──────────┴────────┘       │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                  조사 상세 (/detective/[id])                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 조사 정보: D-001 | 김XX 사건 | 미행조사                      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌──────────────┬──────────────────────────────────────────────┐ │
│  │ 진행상황     │ 증거 업로드                                  │ │
│  │              │ ┌────────────────────────────────────┐       │ │
│  │ ○ 조사시작   │ │ 📁 파일을 드래그하여 업로드        │       │ │
│  │ ○ 1차리포트  │ │                                    │       │ │
│  │ ◐ 2차리포트  │ │ 지원: 이미지, 영상, 오디오, PDF    │       │ │
│  │ ○ 최종리포트 │ └────────────────────────────────────┘       │ │
│  │              │                                              │ │
│  │              │ [업로드된 파일]                              │ │
│  │              │ - 20240125_미행사진1.jpg                     │ │
│  │              │ - 20240125_녹음.mp3                          │ │
│  │              │ - 20240126_미행사진2.jpg                     │ │
│  └──────────────┴──────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 리포트 작성                                                 │ │
│  │ ┌───────────────────────────────────────────────────────┐   │ │
│  │ │ 2024년 1월 25일 미행 조사 결과...                     │   │ │
│  │ │ 대상자는 오후 7시경 강남역에서...                     │   │ │
│  │ └───────────────────────────────────────────────────────┘   │ │
│  │                                           [임시저장] [제출] │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 4.3 탐정 페이지 API 설계

| 엔드포인트 | 메서드 | 설명 | 권한 |
|-----------|--------|------|------|
| `/detective/investigations` | GET | 조사 목록 조회 | Lawyer, Detective |
| `/detective/investigations` | POST | 새 조사 의뢰 | Lawyer |
| `/detective/investigations/{id}` | GET | 조사 상세 | Lawyer, Detective |
| `/detective/investigations/{id}/accept` | POST | 조사 수락 | Detective |
| `/detective/investigations/{id}/evidence` | POST | 증거 업로드 | Detective |
| `/detective/investigations/{id}/report` | POST | 리포트 제출 | Detective |
| `/detective/investigations/{id}/complete` | POST | 조사 완료 | Detective |

### 4.4 탐정 페이지 데이터 모델

```json
{
  "investigation_id": "uuid",
  "case_id": "case_123",
  "investigation_type": "surveillance | audio | photo | document",
  "status": "pending | assigned | in_progress | completed | cancelled",
  "requested_by": "lawyer_user_id",
  "assigned_to": "detective_user_id | null",
  "description": "조사 요청 내용",
  "budget_range": { "min": 500000, "max": 1000000 },
  "deadline": "2024-02-01T00:00:00Z",
  "created_at": "2024-01-20T10:00:00Z",
  "reports": [
    {
      "report_id": "uuid",
      "report_type": "progress | final",
      "content": "리포트 내용",
      "evidence_ids": ["ev_1", "ev_2"],
      "submitted_at": "2024-01-25T15:00:00Z"
    }
  ]
}
```

---

## 5. 유저 업로드 페이지 (Client Upload Portal)

### 5.1 개요

의뢰인 업로드 포털은 **변호사가 의뢰인에게 공유하는 읽기 전용 페이지**로, 의뢰인이 직접 증거를 안전하게 업로드할 수 있다.

### 5.2 접근 방식

```
변호사                                     의뢰인
  │                                          │
  │  1. 의뢰인 초대 링크 생성                │
  │  (/cases/[id]/invite-client)             │
  │                                          │
  │  2. 초대 링크 전달 (이메일/카톡)         │
  │  ──────────────────────────────────────→ │
  │  https://leh.app/client/abc123xyz        │
  │                                          │
  │                                          │  3. 링크 클릭
  │                                          │  4. 간단 인증 (이름+전화번호)
  │                                          │  5. 증거 업로드
  │                                          │
  │  6. 업로드 알림 수신                    ←│
  │  (이메일/대시보드 알림)                  │
```

### 5.3 의뢰인 포털 화면 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│                 의뢰인 인증 (/client/[token])                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    [CHAGOK 로고]                               │ │
│  │                                                             │ │
│  │           안녕하세요, 김XX 변호사님의 의뢰입니다.           │ │
│  │                                                             │ │
│  │     증거 제출을 위해 아래 정보를 입력해 주세요.             │ │
│  │                                                             │ │
│  │     이름: [____________]                                    │ │
│  │     전화번호: [____________]                                │ │
│  │                                                             │ │
│  │                    [확인]                                   │ │
│  │                                                             │ │
│  │     * 입력하신 정보는 본인 확인에만 사용됩니다.             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 인증 성공
┌──────────────────────────────────────────────────────────────────┐
│                 의뢰인 업로드 포털 (/client/[token]/upload)       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    [CHAGOK 로고]                               │ │
│  │                                                             │ │
│  │           김XX 변호사님께 증거를 제출합니다.                 │ │
│  │           사건번호: 2024-이혼-0123                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  ┌───────────────────────────────────────────────────────┐  │ │
│  │  │                                                       │  │ │
│  │  │       📁 파일을 여기에 끌어다 놓거나                  │  │ │
│  │  │          클릭하여 업로드하세요                        │  │ │
│  │  │                                                       │  │ │
│  │  │   지원 형식: 이미지, PDF, 오디오, 동영상              │  │ │
│  │  │   최대 용량: 파일당 100MB                             │  │ │
│  │  │                                                       │  │ │
│  │  └───────────────────────────────────────────────────────┘  │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 업로드된 파일 (3개)                                         │ │
│  │                                                             │ │
│  │  ✅ 카카오톡_대화내역.txt .................. 완료          │ │
│  │  ✅ 증거사진_20240115.jpg .................. 완료          │ │
│  │  ⏳ 녹음파일.mp3 ........................... 업로드 중 75%  │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  📌 주의사항                                                │ │
│  │  • 업로드된 파일은 담당 변호사님께만 전달됩니다.            │ │
│  │  • 개인정보는 암호화되어 안전하게 보호됩니다.               │ │
│  │  • 문의사항은 담당 변호사님께 연락해 주세요.                │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │     [모두 제출 완료]                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 제출 완료
┌──────────────────────────────────────────────────────────────────┐
│                 제출 완료 화면                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    [CHAGOK 로고]                               │ │
│  │                                                             │ │
│  │           ✅ 파일 3개가 안전하게 전송되었습니다.            │ │
│  │                                                             │ │
│  │           담당 변호사님께 알림이 전송되었습니다.            │ │
│  │                                                             │ │
│  │           추가로 제출할 파일이 있으시면                     │ │
│  │           언제든 이 링크로 다시 접속하실 수 있습니다.       │ │
│  │                                                             │ │
│  │                 [추가 파일 업로드]                          │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 5.4 의뢰인 포털 API 설계

| 엔드포인트 | 메서드 | 설명 | 권한 |
|-----------|--------|------|------|
| `/client/invite` | POST | 의뢰인 초대 링크 생성 | Lawyer |
| `/client/{token}/verify` | POST | 의뢰인 인증 | Public |
| `/client/{token}/presigned-url` | POST | 업로드 URL 발급 | Client Token |
| `/client/{token}/upload-complete` | POST | 업로드 완료 알림 | Client Token |
| `/client/{token}/submissions` | GET | 제출 이력 조회 | Client Token |

### 5.5 의뢰인 초대 토큰 데이터 모델

```json
{
  "token": "abc123xyz",
  "case_id": "case_123",
  "invited_by": "lawyer_user_id",
  "client_name": "홍길동",
  "client_phone": "010-1234-5678",
  "expires_at": "2024-02-01T00:00:00Z",
  "is_verified": false,
  "verified_at": null,
  "submissions": [
    {
      "evidence_id": "ev_1",
      "filename": "카카오톡_대화내역.txt",
      "submitted_at": "2024-01-25T10:00:00Z"
    }
  ]
}
```

---

## 6. 법률문서 페이지 (Legal Documents)

### 6.1 개요

법률문서 페이지는 **변호사가 자주 사용하는 문서 템플릿을 관리**하고, **Draft 생성 시 템플릿을 적용**할 수 있는 기능을 제공한다.

### 6.2 법률문서 관리 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│                    법률문서 (/documents)                          │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 문서 템플릿 관리                          [+ 새 템플릿]      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌──────────────┬───────────────────────────────────────────────┐│
│  │ 카테고리     │ 템플릿 목록                                   ││
│  │              │                                               ││
│  │ ▸ 전체 (15)  │  ┌─────────────────────────────────────────┐ ││
│  │ ▸ 소장 (5)   │  │ 📄 이혼소송 소장 템플릿 v2.0            │ ││
│  │ ▸ 답변서 (4) │  │    카테고리: 소장 | 최근수정: 3일 전    │ ││
│  │ ▸ 준비서면(3)│  │    [미리보기] [편집] [복사] [삭제]      │ ││
│  │ ▸ 기타 (3)   │  └─────────────────────────────────────────┘ ││
│  │              │                                               ││
│  │              │  ┌─────────────────────────────────────────┐ ││
│  │              │  │ 📄 양육권 답변서 템플릿                  │ ││
│  │              │  │    카테고리: 답변서 | 최근수정: 1주 전   │ ││
│  │              │  │    [미리보기] [편집] [복사] [삭제]      │ ││
│  │              │  └─────────────────────────────────────────┘ ││
│  │              │                                               ││
│  │              │  ┌─────────────────────────────────────────┐ ││
│  │              │  │ 📄 재산분할 준비서면                     │ ││
│  │              │  │    카테고리: 준비서면 | 최근수정: 2주 전 │ ││
│  │              │  │    [미리보기] [편집] [복사] [삭제]      │ ││
│  │              │  └─────────────────────────────────────────┘ ││
│  └──────────────┴───────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘
```

### 6.3 템플릿 편집기 화면

```
┌──────────────────────────────────────────────────────────────────┐
│             템플릿 편집기 (/documents/[id]/edit)                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 이혼소송 소장 템플릿 v2.0                [저장] [미리보기]  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌──────────────┬───────────────────────────────────────────────┐│
│  │ 변수 설정    │ 에디터                                        ││
│  │              │                                               ││
│  │ {{원고이름}} │  ┌─────────────────────────────────────────┐ ││
│  │ {{피고이름}} │  │                 소    장                │ ││
│  │ {{사건번호}} │  │                                         │ ││
│  │ {{청구취지}} │  │ 원고: {{원고이름}}                      │ ││
│  │ {{청구원인}} │  │ 피고: {{피고이름}}                      │ ││
│  │ {{증거목록}} │  │                                         │ ││
│  │              │  │ 청구취지                                │ ││
│  │ [+ 변수추가] │  │ {{청구취지}}                            │ ││
│  │              │  │                                         │ ││
│  │              │  │ 청구원인                                │ ││
│  │──────────────│  │ {{청구원인}}                            │ ││
│  │ AI 자동채움  │  │                                         │ ││
│  │              │  │ 증거목록                                │ ││
│  │ ☑ 청구취지   │  │ {{증거목록}}                            │ ││
│  │ ☑ 청구원인   │  │                                         │ ││
│  │ ☑ 증거목록   │  └─────────────────────────────────────────┘ ││
│  │ ☐ 원고이름   │                                               ││
│  │ ☐ 피고이름   │                                               ││
│  └──────────────┴───────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘
```

### 6.4 Draft 생성 시 템플릿 선택

```
┌──────────────────────────────────────────────────────────────────┐
│              Draft 생성 모달 (케이스 상세에서 호출)               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   AI 초안 생성                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 1. 템플릿 선택                                              │ │
│  │                                                             │ │
│  │   ○ 기본 템플릿 (CHAGOK 제공)                                  │ │
│  │   ● 내 템플릿 사용                                          │ │
│  │     ┌─────────────────────────────────────────┐             │ │
│  │     │ 이혼소송 소장 템플릿 v2.0        ▾     │             │ │
│  │     └─────────────────────────────────────────┘             │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 2. 증거 선택                                                │ │
│  │                                                             │ │
│  │   ☑ 전체 증거 사용 (24개)                                   │ │
│  │   ☐ 선택한 증거만 사용                                      │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 3. 생성 옵션                                                │ │
│  │                                                             │ │
│  │   ☑ 증거 인용 포함                                          │ │
│  │   ☑ Article 840 태그 기반 분류                              │ │
│  │   ☐ 상세 설명 포함 (초안 길이 증가)                         │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                [취소]              [초안 생성]              │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 6.5 법률문서 API 설계

| 엔드포인트 | 메서드 | 설명 | 권한 |
|-----------|--------|------|------|
| `/documents/templates` | GET | 템플릿 목록 조회 | Lawyer |
| `/documents/templates` | POST | 새 템플릿 생성 | Lawyer |
| `/documents/templates/{id}` | GET | 템플릿 상세 | Lawyer |
| `/documents/templates/{id}` | PUT | 템플릿 수정 | Lawyer |
| `/documents/templates/{id}` | DELETE | 템플릿 삭제 | Lawyer |
| `/documents/templates/{id}/duplicate` | POST | 템플릿 복사 | Lawyer |
| `/documents/categories` | GET | 카테고리 목록 | Lawyer |
| `/cases/{id}/draft-preview` | POST | Draft 생성 (템플릿 적용) | Lawyer |

### 6.6 템플릿 데이터 모델

```json
{
  "template_id": "uuid",
  "name": "이혼소송 소장 템플릿 v2.0",
  "category": "complaint | answer | brief | other",
  "content": "소장 본문 (변수 포함)",
  "variables": [
    { "name": "원고이름", "type": "text", "ai_fillable": false },
    { "name": "피고이름", "type": "text", "ai_fillable": false },
    { "name": "청구취지", "type": "rich_text", "ai_fillable": true },
    { "name": "청구원인", "type": "rich_text", "ai_fillable": true },
    { "name": "증거목록", "type": "evidence_list", "ai_fillable": true }
  ],
  "created_by": "user_id",
  "firm_id": "firm_123",
  "is_shared": true,
  "created_at": "2024-01-15T10:00:00Z",
  "updated_at": "2024-01-20T15:30:00Z"
}
```

---

## 7. 관리자 흐름 (Admin Flows)

### 7.1 사용자 관리

```
┌──────────────────────────────────────────────────────────────────┐
│                사용자 관리 (/admin/users)                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 사용자 목록                    [검색] [+ 사용자 초대]        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ┌──────────┬───────────────┬──────────┬──────────┬────────┐ │ │
│  │ │ 이름     │ 이메일        │ 역할     │ 상태     │ 액션   │ │ │
│  │ ├──────────┼───────────────┼──────────┼──────────┼────────┤ │ │
│  │ │ 김변호사 │ kim@firm.com  │ Admin    │ 활성     │ [···]  │ │ │
│  │ │ 이스태프 │ lee@firm.com  │ Staff    │ 활성     │ [···]  │ │ │
│  │ │ 박변호사 │ park@firm.com │ Lawyer   │ 비활성   │ [···]  │ │ │
│  │ └──────────┴───────────────┴──────────┴──────────┴────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  [···] 메뉴: 역할 변경 | 비활성화 | 삭제                         │
└──────────────────────────────────────────────────────────────────┘
```

### 7.2 감사 로그

```
┌──────────────────────────────────────────────────────────────────┐
│                   감사 로그 (/admin/audit)                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 활동 로그         [날짜 범위] [사용자] [액션] [CSV 내보내기] │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ┌──────────────┬──────────┬──────────┬────────────────────┐ │ │
│  │ │ 시간         │ 사용자   │ 액션     │ 상세               │ │ │
│  │ ├──────────────┼──────────┼──────────┼────────────────────┤ │ │
│  │ │ 2024-01-25   │ 김변호사 │ LOGIN    │ IP: 192.168.1.1   │ │ │
│  │ │ 14:32:15     │          │          │                    │ │ │
│  │ │ 2024-01-25   │ 김변호사 │ VIEW     │ Case: 2024-0123   │ │ │
│  │ │ 14:33:22     │          │          │                    │ │ │
│  │ │ 2024-01-25   │ 이스태프 │ CREATE   │ Evidence: ev_456  │ │ │
│  │ │ 14:45:10     │          │          │                    │ │ │
│  │ └──────────────┴──────────┴──────────┴────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

---

## 8. 모바일 반응형 고려사항

### 8.1 모바일 (< 768px)

- 네비게이션: 햄버거 메뉴
- 케이스 목록: 1-Column 카드 리스트
- 증거 타임라인: 세로형 스크롤
- Draft: 전체 화면 에디터

### 8.2 태블릿 (768px - 1024px)

- 네비게이션: 축소된 사이드바
- 케이스 목록: 2-Column 그리드
- 케이스 상세: 탭 기반 UI (증거/Draft 탭 전환)

### 8.3 데스크톱 (> 1024px)

- 네비게이션: 전체 사이드바
- 케이스 목록: 3-Column 그리드 또는 테이블
- 케이스 상세: 분할 레이아웃 (필터 | 타임라인 | Draft)

---

## 9. 에러 처리 및 예외 흐름

### 9.1 인증 에러

```
JWT 만료 → 로그인 페이지 리다이렉트
권한 없음 → "접근 권한이 없습니다" 토스트 + 대시보드 이동
```

### 9.2 업로드 에러

```
파일 크기 초과 → "파일 크기는 100MB 이하여야 합니다" 에러 메시지
지원하지 않는 형식 → "지원하지 않는 파일 형식입니다" 에러 메시지
네트워크 오류 → "업로드 실패. 재시도 버튼을 클릭해주세요" + [재시도] 버튼
```

### 9.3 AI 처리 에러

```
분석 실패 → "AI 분석 중 오류가 발생했습니다. 관리자에게 문의해주세요"
Draft 생성 실패 → "초안 생성에 실패했습니다. 다시 시도해주세요" + [재시도] 버튼
```

---

## 10. 향후 개발 우선순위

### Phase 1: 의뢰인 포털 (우선순위: 높음)
- 의뢰인 초대 링크 생성
- 의뢰인 인증 및 업로드
- 업로드 알림 시스템

### Phase 2: 법률문서 관리 (우선순위: 중간)
- 템플릿 CRUD
- Draft 생성 시 템플릿 적용
- 변수 자동 채움

### Phase 3: 탐정 연동 (우선순위: 낮음)
- 탐정 의뢰 시스템
- 탐정 대시보드
- 조사 결과 연동

---

## 11. 참고 문서

- [PRD.md](../specs/PRD.md) - 제품 요구사항
- [FRONTEND_SPEC.md](../specs/FRONTEND_SPEC.md) - 프론트엔드 상세 설계
- [API_SPEC.md](../specs/API_SPEC.md) - API 명세
- [UI_UX_DESIGN.md](UI_UX_DESIGN.md) - 디자인 시스템
- [plan.md](plan.md) - TDD 개발 플랜

---

# END OF USERFLOW.md
