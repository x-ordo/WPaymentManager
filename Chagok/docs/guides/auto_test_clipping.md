# auto_test_clipping.md — CHAGOK 자동 테스트 클리핑 규칙

> 목적:  
> AI가 테스트를 생성하거나 사람이 테스트를 추가할 때,  
> **중복/과잉/위험/취약한 테스트를 자동으로 걸러내는 규칙**을 정의한다.

---

## 1. plan.md 외 테스트 생성 금지

- AI는 **반드시 `plan.md` 에 정의된 항목 안에서만** 테스트를 만든다.
- plan.md 에 없는 기능은:
  - 먼저 사람(또는 P/H/L)이 plan.md 에 새로운 항목을 추가한 뒤,
  - 그 다음에만 테스트를 만들 수 있다.

---

## 2. 법률/AI 도메인 특수 규칙

### 2.1 금지되는 테스트 범주

- “승소율”, “판결 결과”를 예측하는 테스트
- 특정 사건에서 “AI가 어떤 법률적 결론을 내려야 한다”고 강제하는 테스트
- 실제 사건 이름/실명/주민번호/전화번호 등 민감한 개인정보를 포함한 fixture

### 2.2 허용되는 테스트 범주

- 증거 요약 / 라벨링 / 타임라인 / Draft 구조/형식 테스트
- 프롬프트에 **Hallucination 금지 규칙, 책임 한계 문구** 포함 여부 테스트
- 출력이 “법률적 판단이 아닌, 사실 요약 및 구조화된 초안”인지 확인하는 테스트

---

## 3. AI 모델 호출 관련 테스트 클리핑

### 3.1 실제 모델 호출 테스트는 금지

아래 테스트는 자동 제거 대상이다:

- GPT-4o, Whisper, Vision, Embedding API 를 **실제 호출**하는 테스트
- 호출 시간/속도를 측정하는 테스트 (성능 벤치마크는 별도)
- 실제 OpenAI 비용을 발생시키는 테스트

### 3.2 허용되는 형태

- 모든 모델 호출은 **mock/fake** 를 사용한다.
- Prompt 내용/형식, response 구조 (필드 유무)만 검증한다.

---

## 4. UI/디자인 관련 과잉 테스트 클리핑

### 4.1 금지되는 UI 테스트

- 정확한 픽셀 값/좌표를 비교하는 테스트 (예: width == 312px)
- 특정 CSS class 이름을 직접 비교하는 테스트 (Tailwind class 문자열 전체 비교)
- 아이콘의 색상 hex 값만을 단독으로 검증하는 테스트

### 4.2 허용되는 UI 테스트

- 중요한 상태/정보/경고/버튼/Disclaimer 의 존재 여부
- 인터랙션 결과 (버튼 클릭 → 모달 표시 등)
- “Calm Control” UX의 핵심 규칙:
  - 삭제 전 확인 모달
  - 업로드/분석 중 상태 피드백
  - AI 결과물임을 명시하는 텍스트 노출

---

## 5. 중복 테스트 제거 규칙

다음 조건 중 하나라도 만족하면, AI는 “중복 테스트”로 판단하고 새 테스트 작성을 중단한다:

1. 기존 테스트와 **Given/When/Then 구조가 거의 동일**하다.
2. assertion으로 검증하는 필드/텍스트가 완전히 같고, 단지 fixture 파일명만 다르다.
3. 같은 엔드포인트에 대해, 이미 동일한 시나리오를 다른 테스트 이름으로 검증하고 있다.

> 이 경우:  
>
> - 기존 테스트를 **파라미터화** 하는 방향으로 리팩터링을 고려하고,  
> - 새 테스트는 생성하지 않는다.

---

## 6. 과도한 범위/시간 소모 테스트 클리핑

아래와 같은 테스트는 자동으로 제거하거나, 별도의 “Long-running 테스트” 그룹으로 분리한다:

- 1분 이상 소요될 수 있는 대량 데이터 처리 테스트
- 수십/수백 개의 PDF/이미지 fixture 를 한 번에 로딩하는 테스트
- FE e2e 테스트(Playwright/Cypress)에서 Oracle Cloud 실제 배포 URL 을 대상으로 하는 광범위 시나리오

> TDD 루프에는 “짧고 자주 실행되는 테스트” 만 남겨둔다.  
> 장시간/부하 테스트는 별도 스위트(예: `pytest -m slow`) 로 관리한다.

---

## 7. CI/CD 관련 테스트 클리핑

### 7.1 금지되는 CI/CD 테스트

- 실제 Oracle Cloud API 를 호출하여 리소스를 생성/삭제하는 테스트
- 실제 배포 파이프라인을 실행해 보는 테스트 (테스트 실행 시마다 배포 발생)
- 실제 AWS/OCI Secret 값을 출력하거나 로그에 남기는 테스트

### 7.2 허용되는 CI/CD 테스트

- `.github/workflows/*.yml` 을 **파싱**해서:
  - 브랜치 필터, job dependencies(`needs`) 구조, secret 참조 방식 등을 검사
- CI가 실패하면 CD job 이 실행되지 않도록 정의되어 있는지 확인
- main 에 대한 배포가 GitHub Environment 의 manual approval 을 요구하는지 확인

---

## 8. 보안 관점에서 제거해야 하는 테스트

### 8.1 금지

- 실 서비스용 JWT Secret 을 테스트 코드에 하드코딩하는 행위
- 실제 운영 DB/스토리지에 연결하는 테스트
- 실제 운영 S3 버킷에 Presigned URL 을 발급하는 테스트

### 8.2 허용

- 테스트 전용 Secret/Key (로컬/CI 전용) 사용
- Localstack, DynamoDB Local, Qdrant Test Container 등 **격리된 환경**에서의 통합 테스트
- JWT Secret 이 설정되지 않았을 때 서버가 부팅을 거부하는지 확인하는 테스트

---

## 9. 데이터/개인정보 관련 클리핑 규칙

- 실제 카카오톡 대화, 실제 녹취 텍스트, 실제 이름/전화번호 등을 fixture 로 쓰지 않는다.
- 테스트용 예시는 반드시 **가상의 인물/내용**을 사용한다.
- 만약 기존 테스트에 실제 데이터가 포함되어 있다면:
  - 해당 테스트는 우선 비활성화하고,
  - 익명화된 fixture 로 교체하기 전까지 새 테스트를 추가하지 않는다.

---

## 10. Draft 관련 테스트 제한

- Draft 텍스트가 **법적 결론/판단을 대신하는지**를 assert 하는 테스트는 작성하지 않는다.
- “이 문서가 바로 제출 가능한 완성본이어야 한다” 는 식의 기대를 검증하지 않는다.
- 허용되는 검증 범위:
  - Draft 구조가 “청구취지/청구원인” 등 섹션으로 나뉘는지
  - 각 섹션에 **실제 RAG 기반 인용문이 포함**되는지
  - 상단에 AI Disclaimer 가 존재하는지

---

## 11. 테스트 추가/수정 시 체크리스트

테스트를 새로 만들거나 수정할 때, 아래 질문들에 “예”를 답할 수 있어야 한다.

1. 이 테스트는 **plan.md 의 항목 하나**에 명확히 대응하는가?
2. 이 테스트는 이미 존재하는 테스트와 **행동 수준에서 중복되지 않는가?**
3. 이 테스트는 AI 비용, 외부 API 호출 비용을 발생시키지 않는가?
4. 이 테스트는 UI의 “모양”이 아니라 “행동/상태/정보 전달”을 검증하는가?
5. 이 테스트는 민감정보, 실제 데이터를 포함하지 않는가?
6. 이 테스트는 CI에서 빠르게(수 초 수준) 실행 가능한가?

> 하나라도 “아니오”라면, 테스트를 만들기 전에 먼저 설계를 수정하거나  
> plan.md / claude.md / SECURITY_COMPLIANCE.md 를 다시 확인한다.
